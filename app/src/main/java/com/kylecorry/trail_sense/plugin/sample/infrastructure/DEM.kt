package com.kylecorry.trail_sense.plugin.sample.infrastructure

import android.content.Context
import android.util.Size
import com.kylecorry.andromeda.core.cache.GeospatialCache
import com.kylecorry.andromeda.core.coroutines.onIO
import com.kylecorry.sol.math.SolMath.roundNearest
import com.kylecorry.sol.science.geology.CoordinateBounds
import com.kylecorry.sol.units.Coordinate
import com.kylecorry.sol.units.Distance

object DEM {

    // Cache
    private var cache = GeospatialCache<Distance>(Distance.meters(100f), size = 40)
    private val resolution = (1 / 240.0) / 4

    // Image data source
    @Suppress("TYPE_INTERSECTION_AS_REIFIED_WARNING")
    private val compressionFactors = arrayOf(
        arrayOf("S45W090", 0.09084335714578629, 1828.0, -45.0, -90.0, -60.0, -75.0),
        arrayOf("S45W075", 0.04853461682796478, 1358.1971435546875, -45.0, -75.0, -60.0, -60.0),
        arrayOf("S45W060", 0.313506543636322, 132.0, -45.0, -60.0, -60.0, -45.0),
        arrayOf("S45W045", 0.0714307576417923, 778.7109985351562, -45.0, -45.0, -60.0, -30.0),
        arrayOf("S45W030", 0.0714886486530304, 2386.0, -45.0, -30.0, -60.0, -15.0),
        arrayOf("S45E000", 0.22200584411621094, 445.0, -45.0, 0.0, -60.0, 15.0),
        arrayOf("S45E030", 0.10683077573776245, 1207.0, -45.0, 30.0, -60.0, 45.0),
        arrayOf("S45E045", 0.14424939453601837, 955.0, -45.0, 45.0, -60.0, 60.0),
        arrayOf("S45E060", 0.08377063274383545, 425.0, -45.0, 60.0, -60.0, 75.0),
        arrayOf("S45E150", 0.17295271158218384, 1119.0, -45.0, 150.0, -60.0, 165.0),
        arrayOf("S45E165", 0.08807806670665741, 717.0, -45.0, 165.0, -60.0, 180.0),
        arrayOf("S30W180", 0.6471667885780334, 107.0, -30.0, -180.0, -45.0, -165.0),
        arrayOf("S30W090", 0.07865515351295471, 1337.0, -30.0, -90.0, -45.0, -75.0),
        arrayOf("S30W075", 0.03376903757452965, 775.0, -30.0, -75.0, -45.0, -60.0),
        arrayOf("S30W060", 0.262879878282547, 384.0, -30.0, -60.0, -45.0, -45.0),
        arrayOf("S30W015", 0.050425153225660324, 1457.0, -30.0, -15.0, -45.0, 0.0),
        arrayOf("S30E015", 0.08087637275457382, 157.0, -30.0, 15.0, -45.0, 30.0),
        arrayOf("S30E030", 0.18373365700244904, 39.0, -30.0, 30.0, -45.0, 45.0),
        arrayOf("S30E075", 0.14103981852531433, 949.0, -30.0, 75.0, -45.0, 90.0),
        arrayOf("S30E105", 0.19387398660182953, 316.0, -30.0, 105.0, -45.0, 120.0),
        arrayOf("S30E120", 0.3027823567390442, 289.0, -30.0, 120.0, -45.0, 135.0),
        arrayOf("S30E135", 0.07798273116350174, 1081.0, -30.0, 135.0, -45.0, 150.0),
        arrayOf("S30E150", 0.11999280005693436, 565.0, -30.0, 150.0, -45.0, 165.0),
        arrayOf("S30E165", 0.05630810558795929, 957.0, -30.0, 165.0, -45.0, 180.0),
        arrayOf("S15W180", 0.09833230078220367, 1454.0, -15.0, -180.0, -30.0, -165.0),
        arrayOf("S15W165", 0.04976580664515495, 3128.0, -15.0, -165.0, -30.0, -150.0),
        arrayOf("S15W150", 0.05006872117519379, 2486.0, -15.0, -150.0, -30.0, -135.0),
        arrayOf("S15W135", 0.06812717020511627, 850.0, -15.0, -135.0, -30.0, -120.0),
        arrayOf("S15W120", 0.12218762934207916, 1615.0, -15.0, -120.0, -30.0, -105.0),
        arrayOf("S15W090", 0.12049499154090881, 571.0, -15.0, -90.0, -30.0, -75.0),
        arrayOf("S15W075", 0.03427060693502426, 634.0, -15.0, -75.0, -30.0, -60.0),
        arrayOf("S15W060", 0.09823840111494064, 330.0, -15.0, -60.0, -30.0, -45.0),
        arrayOf("S15W045", 0.08350668847560883, 275.0, -15.0, -45.0, -30.0, -30.0),
        arrayOf("S15W030", 0.13212434947490692, 1853.0, -15.0, -30.0, -30.0, -15.0),
        arrayOf("S15W015", 0.05815279483795166, 907.0, -15.0, -15.0, -30.0, 0.0),
        arrayOf("S15E000", 0.08719656616449356, 448.0, -15.0, 0.0, -30.0, 15.0),
        arrayOf("S15E015", 0.07258132845163345, 66.0, -15.0, 15.0, -30.0, 30.0),
        arrayOf("S15E030", 0.0573313906788826, 1593.0, -15.0, 30.0, -30.0, 45.0),
        arrayOf("S15E045", 0.057781364768743515, 1421.0, -15.0, 45.0, -30.0, 60.0),
        arrayOf("S15E060", 0.34349560737609863, 395.0, -15.0, 60.0, -30.0, 75.0),
        arrayOf("S15E105", 0.1945248544216156, 118.0, -15.0, 105.0, -30.0, 120.0),
        arrayOf("S15E120", 0.168434277176857, 103.0, -15.0, 120.0, -30.0, 135.0),
        arrayOf("S15E135", 0.11368674039840698, 708.2596435546875, -15.0, 135.0, -30.0, 150.0),
        arrayOf("S15E150", 0.09977364540100098, 1011.0897216796875, -15.0, 150.0, -30.0, 165.0),
        arrayOf("S15E165", 0.0665072649717331, 2120.0, -15.0, 165.0, -30.0, 180.0),
        arrayOf("N00W180", 0.05341454595327377, 2973.0, 0.0, -180.0, -15.0, -165.0),
        arrayOf("N00W165", 0.05160898715257645, 3355.0, 0.0, -165.0, -15.0, -150.0),
        arrayOf("N00W150", 0.0838230699300766, 1861.0, 0.0, -150.0, -15.0, -135.0),
        arrayOf("N00W105", 0.07723072171211243, 1652.159912109375, 0.0, -105.0, -15.0, -90.0),
        arrayOf("N00W090", 0.03503137826919556, 654.0, 0.0, -90.0, -15.0, -75.0),
        arrayOf("N00W075", 0.04087375849485397, -10.294933319091797, 0.0, -75.0, -15.0, -60.0),
        arrayOf("N00W060", 0.13832321763038635, 207.0, 0.0, -60.0, -15.0, -45.0),
        arrayOf("N00W045", 0.0590277761220932, 643.0, 0.0, -45.0, -15.0, -30.0),
        arrayOf("N00W015", 0.044905103743076324, 4935.07763671875, 0.0, -15.0, -15.0, 0.0),
        arrayOf("N00E000", 0.03412251174449921, 4936.22216796875, 0.0, 0.0, -15.0, 15.0),
        arrayOf("N00E015", 0.061247654259204865, -224.97488403320312, 0.0, 15.0, -15.0, 30.0),
        arrayOf("N00E030", 0.03206812962889671, 2123.0, 0.0, 30.0, -15.0, 45.0),
        arrayOf("N00E045", 0.05807511508464813, 1568.0, 0.0, 45.0, -15.0, 60.0),
        arrayOf("N00E060", 0.14198218286037445, 1627.0, 0.0, 60.0, -15.0, 75.0),
        arrayOf("N00E090", 0.054625701159238815, 995.0, 0.0, 90.0, -15.0, 105.0),
        arrayOf("N00E105", 0.044860076159238815, 2107.0, 0.0, 105.0, -15.0, 120.0),
        arrayOf("N00E120", 0.03546592593193054, 1926.0, 0.0, 120.0, -15.0, 135.0),
        arrayOf("N00E135", 0.03588959202170372, 2397.0, 0.0, 135.0, -15.0, 150.0),
        arrayOf("N00E150", 0.04562109336256981, 2939.0, 0.0, 150.0, -15.0, 165.0),
        arrayOf("N00E165", 0.04902902990579605, 3783.0, 0.0, 165.0, -15.0, 180.0),
        arrayOf("N15W180", 0.09378552436828613, 2104.9697265625, 15.0, -180.0, 0.0, -165.0),
        arrayOf("N15W165", 0.11638521403074265, 1936.0, 15.0, -165.0, 0.0, -150.0),
        arrayOf("N15W120", 0.38288289308547974, 613.0, 15.0, -120.0, 0.0, -105.0),
        arrayOf("N15W105", 0.05002739652991295, 1252.301025390625, 15.0, -105.0, 0.0, -90.0),
        arrayOf("N15W090", 0.034120723605155945, 1779.0, 15.0, -90.0, 0.0, -75.0),
        arrayOf("N15W075", 0.036390189081430435, 1491.0, 15.0, -75.0, 0.0, -60.0),
        arrayOf("N15W060", 0.11001425981521606, 346.9310302734375, 15.0, -60.0, 0.0, -45.0),
        arrayOf("N15W030", 0.04612768068909645, 2848.0, 15.0, -30.0, 0.0, -15.0),
        arrayOf("N15W015", 0.037568721920251846, 4938.9453125, 15.0, -15.0, 0.0, 0.0),
        arrayOf("N15E000", 0.028592076152563095, 4938.45458984375, 15.0, 0.0, 0.0, 15.0),
        arrayOf("N15E015", 0.05436073988676071, -268.28387451171875, 15.0, 15.0, 0.0, 30.0),
        arrayOf("N15E030", 0.0490083172917366, 736.6137084960938, 15.0, 30.0, 0.0, 45.0),
        arrayOf("N15E045", 0.08185210078954697, 662.0, 15.0, 45.0, 0.0, 60.0),
        arrayOf("N15E060", 0.07490687072277069, 2178.0, 15.0, 60.0, 0.0, 75.0),
        arrayOf("N15E075", 0.08430973440408707, 423.0, 15.0, 75.0, 0.0, 90.0),
        arrayOf("N15E090", 0.05788768455386162, 994.0, 15.0, 90.0, 0.0, 105.0),
        arrayOf("N15E105", 0.041548263281583786, 2150.0, 15.0, 105.0, 0.0, 120.0),
        arrayOf("N15E120", 0.048501428216695786, 2430.0, 15.0, 120.0, 0.0, 135.0),
        arrayOf("N15E135", 0.12807634472846985, 1487.0, 15.0, 135.0, 0.0, 150.0),
        arrayOf("N15E150", 0.050137631595134735, 2996.0, 15.0, 150.0, 0.0, 165.0),
        arrayOf("N15E165", 0.0920245423913002, 2068.0, 15.0, 165.0, 0.0, 180.0),
        arrayOf("N30W180", 0.15194377303123474, 949.25244140625, 30.0, -180.0, 15.0, -165.0),
        arrayOf("N30W165", 0.04794638603925705, 1165.8739013671875, 30.0, -165.0, 15.0, -150.0),
        arrayOf("N30W120", 0.04085012525320053, 2986.249267578125, 30.0, -120.0, 15.0, -105.0),
        arrayOf("N30W105", 0.03992638364434242, 872.0, 30.0, -105.0, 15.0, -90.0),
        arrayOf("N30W090", 0.053951479494571686, 1825.0, 30.0, -90.0, 15.0, -75.0),
        arrayOf("N30W075", 0.05289587751030922, 1781.55224609375, 30.0, -75.0, 15.0, -60.0),
        arrayOf("N30W030", 0.05197741463780403, 1314.6981201171875, 30.0, -30.0, 15.0, -15.0),
        arrayOf("N30W015", 0.08469369262456894, 737.5819702148438, 30.0, -15.0, 15.0, 0.0),
        arrayOf("N30E000", 0.09562582522630692, -118.07440185546875, 30.0, 0.0, 15.0, 15.0),
        arrayOf("N30E015", 0.07210322469472885, 133.30990600585938, 30.0, 15.0, 15.0, 30.0),
        arrayOf("N30E030", 0.049879495054483414, 1547.0, 30.0, 30.0, 15.0, 45.0),
        arrayOf("N30E045", 0.048200421035289764, 901.0, 30.0, 45.0, 15.0, 60.0),
        arrayOf("N30E060", 0.06300551444292068, 201.0, 30.0, 60.0, 15.0, 75.0),
        arrayOf("N30E075", 0.028463900089263916, 373.0, 30.0, 75.0, 15.0, 90.0),
        arrayOf("N30E090", 0.03336365520954132, 269.0, 30.0, 90.0, 15.0, 105.0),
        arrayOf("N30E105", 0.07116559892892838, 1056.0, 30.0, 105.0, 15.0, 120.0),
        arrayOf("N30E120", 0.048307936638593674, 1514.0, 30.0, 120.0, 15.0, 135.0),
        arrayOf("N30E135", 0.09777107834815979, 1745.9114990234375, 30.0, 135.0, 15.0, 150.0),
        arrayOf("N30E150", 0.10083036869764328, 2425.0, 30.0, 150.0, 15.0, 165.0),
        arrayOf("N30E165", 0.22013448178768158, 1150.958740234375, 30.0, 165.0, 15.0, 180.0),
        arrayOf("N45W135", 0.05597636476159096, 363.6120910644531, 45.0, -135.0, 30.0, -120.0),
        arrayOf("N45W120", 0.052183110266923904, 558.031494140625, 45.0, -120.0, 30.0, -105.0),
        arrayOf("N45W105", 0.06284404546022415, 38.2157096862793, 45.0, -105.0, 30.0, -90.0),
        arrayOf("N45W090", 0.11851152777671814, 166.0, 45.0, -90.0, 30.0, -75.0),
        arrayOf("N45W075", 0.1140824556350708, 382.08245849609375, 45.0, -75.0, 30.0, -60.0),
        arrayOf("N45W060", 4.818062782287598, 41.0, 45.0, -60.0, 30.0, -45.0),
        arrayOf("N45W045", 0.15761522948741913, 760.48974609375, 45.0, -45.0, 30.0, -30.0),
        arrayOf("N45W030", 0.07372299581766129, 1233.5440673828125, 45.0, -30.0, 30.0, -15.0),
        arrayOf("N45W015", 0.05296965315937996, 761.0, 45.0, -15.0, 30.0, 0.0),
        arrayOf("N45E000", 0.05303703621029854, 919.0, 45.0, 0.0, 30.0, 15.0),
        arrayOf("N45E015", 0.045774877071380615, 2432.0, 45.0, 15.0, 30.0, 30.0),
        arrayOf("N45E030", 0.037247832864522934, 1263.5338134765625, 45.0, 30.0, 30.0, 45.0),
        arrayOf("N45E045", 0.04511437937617302, 155.88967895507812, 45.0, 45.0, 30.0, 60.0),
        arrayOf("N45E060", 0.03192624822258949, 15.950799942016602, 45.0, 60.0, 30.0, 75.0),
        arrayOf("N45E075", 0.029603293165564537, 154.46435546875, 45.0, 75.0, 30.0, 90.0),
        arrayOf("N45E090", 0.036848582327365875, -45.646976470947266, 45.0, 90.0, 30.0, 105.0),
        arrayOf("N45E105", 0.06726737320423126, 117.462890625, 45.0, 105.0, 30.0, 120.0),
        arrayOf("N45E120", 0.07331199198961258, 806.0, 45.0, 120.0, 30.0, 135.0),
        arrayOf("N45E135", 0.04270382225513458, 2290.0, 45.0, 135.0, 30.0, 150.0),
        arrayOf("N60W180", 0.09094402939081192, 834.0, 60.0, -180.0, 45.0, -165.0),
        arrayOf("N60W165", 0.08343715220689774, 289.0, 60.0, -165.0, 45.0, -150.0),
        arrayOf("N60W150", 0.04892445728182793, 631.4257202148438, 60.0, -150.0, 45.0, -135.0),
        arrayOf("N60W135", 0.049572862684726715, 776.0, 60.0, -135.0, 45.0, -120.0),
        arrayOf("N60W120", 0.06809249520301819, -78.0, 60.0, -120.0, 45.0, -105.0),
        arrayOf("N60W105", 0.18362779915332794, 104.0, 60.0, -105.0, 45.0, -90.0),
        arrayOf("N60W090", 0.2644549012184143, 220.0, 60.0, -90.0, 45.0, -75.0),
        arrayOf("N60W075", 0.13047826290130615, 419.0, 60.0, -75.0, 45.0, -60.0),
        arrayOf("N60W060", 0.1305295079946518, 784.0, 60.0, -60.0, 45.0, -45.0),
        arrayOf("N60W045", 0.1535654366016388, 341.0, 60.0, -45.0, 45.0, -30.0),
        arrayOf("N60W015", 0.16155971586704254, 301.0, 60.0, -15.0, 45.0, 0.0),
        arrayOf("N60E000", 0.047196291387081146, 710.1581420898438, 60.0, 0.0, 45.0, 15.0),
        arrayOf("N60E015", 0.09920834749937057, 104.24872589111328, 60.0, 15.0, 45.0, 30.0),
        arrayOf("N60E030", 0.23906603455543518, 337.37896728515625, 60.0, 30.0, 45.0, 45.0),
        arrayOf("N60E045", 0.15162834525108337, 61.8028450012207, 60.0, 45.0, 45.0, 60.0),
        arrayOf("N60E060", 0.17035642266273499, 254.0237274169922, 60.0, 60.0, 45.0, 75.0),
        arrayOf("N60E075", 0.05585378035902977, 69.61138153076172, 60.0, 75.0, 45.0, 90.0),
        arrayOf("N60E090", 0.049141835421323776, 994.0, 60.0, 90.0, 45.0, 105.0),
        arrayOf("N60E105", 0.06244271993637085, 1198.0, 60.0, 105.0, 45.0, 120.0),
        arrayOf("N60E120", 0.10927361994981766, 50.677555084228516, 60.0, 120.0, 45.0, 135.0),
        arrayOf("N60E135", 0.11100542545318604, 256.0, 60.0, 135.0, 45.0, 150.0),
        arrayOf("N60E150", 0.0419582761824131, 1296.0, 60.0, 150.0, 45.0, 165.0),
        arrayOf("N60E165", 0.10420923680067062, 1158.0, 60.0, 165.0, 45.0, 180.0),
        arrayOf("N75W180", 0.1571524441242218, 133.0, 75.0, -180.0, 60.0, -165.0),
        arrayOf("N75W165", 0.04144766926765442, 56.368980407714844, 75.0, -165.0, 60.0, -150.0),
        arrayOf("N75W150", 0.039380837231874466, 609.9535522460938, 75.0, -150.0, 60.0, -135.0),
        arrayOf("N75W135", 0.0806235820055008, 346.0, 75.0, -135.0, 60.0, -120.0),
        arrayOf("N75W120", 0.21632131934165955, 303.0, 75.0, -120.0, 60.0, -105.0),
        arrayOf("N75W105", 0.2763451933860779, 302.0, 75.0, -105.0, 60.0, -90.0),
        arrayOf("N75W090", 0.09362208843231201, 876.0, 75.0, -90.0, 60.0, -75.0),
        arrayOf("N75W075", 0.08341437578201294, 883.0, 75.0, -75.0, 60.0, -60.0),
        arrayOf("N75W060", 0.06207180395722389, 1255.0, 75.0, -60.0, 60.0, -45.0),
        arrayOf("N75W045", 0.05916249379515648, 901.0, 75.0, -45.0, 60.0, -30.0),
        arrayOf("N75W030", 0.04962101951241493, 1531.0, 75.0, -30.0, 60.0, -15.0),
        arrayOf("N75W015", 0.06856869906187057, 1498.0, 75.0, -15.0, 60.0, 0.0),
        arrayOf("N75E000", 0.06910595297813416, 1293.6407470703125, 75.0, 0.0, 60.0, 15.0),
        arrayOf("N75E015", 0.09278348088264465, 724.7176513671875, 75.0, 15.0, 60.0, 30.0),
        arrayOf("N75E030", 0.17039814591407776, 305.0, 75.0, 30.0, 60.0, 45.0),
        arrayOf("N75E045", 0.14836399257183075, 103.0, 75.0, 45.0, 60.0, 60.0),
        arrayOf("N75E060", 0.13191412389278412, 105.0, 75.0, 60.0, 60.0, 75.0),
        arrayOf("N75E075", 0.24947340786457062, 65.3950424194336, 75.0, 75.0, 60.0, 90.0),
        arrayOf("N75E090", 0.15221713483333588, 2.508711099624634, 75.0, 90.0, 60.0, 105.0),
        arrayOf("N75E105", 0.2671872079372406, 17.0, 75.0, 105.0, 60.0, 120.0),
        arrayOf("N75E120", 0.10561960935592651, 107.84648895263672, 75.0, 120.0, 60.0, 135.0),
        arrayOf("N75E135", 0.0815114676952362, 276.4927978515625, 75.0, 135.0, 60.0, 150.0),
        arrayOf("N75E150", 0.11667471379041672, 63.0, 75.0, 150.0, 60.0, 165.0),
        arrayOf("N75E165", 0.10288500040769577, 153.96315002441406, 75.0, 165.0, 60.0, 180.0),
    )

    private val sources = compressionFactors.associate {
        "dem/${it[0]}.webp" to GeographicImageSource(
            Size(3600, 3600),
            CoordinateBounds(
                it[3] as Double,
                it[6] as Double,
                it[5] as Double,
                it[4] as Double
            ),
            decoder = GeographicImageSource.scaledDecoder(
                it[1] as Double,
                it[2] as Double
            ),
            precision = 3
        )
    }

    suspend fun getElevation(context: Context, location: Coordinate): Distance = onIO {
        val rounded = location.copy(
            latitude = location.latitude.roundNearest(resolution),
            longitude = location.longitude.roundNearest(resolution)
        )
        cache.getOrPut(rounded) {
            val image =
                sources.entries.firstOrNull { it.value.contains(rounded) }
                    ?: return@getOrPut Distance.meters(0f)
            Distance.meters(image.value.read(context, image.key, location).first())
        }
    }

}